
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Making Space Invaders Fun and Accessible with Brain-Computer Interfacing &#8212; Making Space Invaders Fun and Accessible with Brain-Computer Interfacing</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Making Space Invaders Fun and Accessible with Brain-Computer Interfacing</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1 current">
  <a class="reference internal" href="#">
   Making Space Invaders Fun and Accessible with Brain-Computer Interfacing
  </a>
 </li>
</ul>
    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/Reproducible_Report.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.sydney.edu.au/wdod8520/Aqua10"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.sydney.edu.au/wdod8520/Aqua10/issues/new?title=Issue%20on%20page%20%2FReproducible_Report.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#executive-summary">
   Executive Summary
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dependencies">
     Dependencies
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#motivation-background">
   Motivation &amp; Background
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#experimentation-data-collection">
   Experimentation &amp; Data Collection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#physical-experiments-performed-findings">
     Physical experiments performed &amp; Findings
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#general-eye-movements">
       General eye movements
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#varying-speed-of-eye-movements">
       Varying speed of eye movements
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#varying-distance-of-eye-movements">
       Varying distance of eye movements
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#electrode-placement">
       Electrode Placement
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#changing-individual-changing-boxes">
       Changing Individual &amp; Changing Boxes
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#determining-how-the-signal-changes-with-natural-movement">
       Determining how the signal changes with natural Movement
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#immediate-implications-of-findings">
     Immediate Implications of Findings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sample-collection-of-data">
     Sample Collection of Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#streaming-algorithm-design">
     Streaming Algorithm Design
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimisation">
   Optimisation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#event-detection-to-do">
     Event Detection TO DO
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#test-statistic">
       Test Statistic
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#evaluation-metric-contrast">
       Evaluation Metric (Contrast)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#threshold-optimisation">
       Threshold Optimisation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classification-to-do">
     Classification TO DO
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#classifiers">
       Classifiers
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#accuracy-metric">
       Accuracy Metric
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#classifier-optimisation">
       Classifier Optimisation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#evaluation">
       Evaluation
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary-of-results">
   Summary of results
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#physics-analysis-findings-to-do">
     Physics Analysis Findings: TO DO
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-analysis-finding-to-do">
     Data analysis finding TO DO
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#discussion">
   Discussion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#space-invaders">
   Space Invaders!
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix">
   Appendix
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="making-space-invaders-fun-and-accessible-with-brain-computer-interfacing">
<h1>Making Space Invaders Fun and Accessible with Brain-Computer Interfacing<a class="headerlink" href="#making-space-invaders-fun-and-accessible-with-brain-computer-interfacing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="executive-summary">
<h2>Executive Summary<a class="headerlink" href="#executive-summary" title="Permalink to this headline">¶</a></h2>
<p>Technological advancements such as gesture control, voice recognition, virtual and augmented reality are redefining gaming, advancing an already booming and competitive industry. The project detailed in this report is a redesigned version of Space Invaders, with the ship controlled using gestures, specifically left and right eye movements. Its development is motivated by the financial success of similarly advanced games such as Pokemon Go and without doubt, the original Space Invaders which was a technological wonder for its time.</p>
<p><a class="reference internal" href="#flow"><span class="std std-numref">Fig. 1</span></a> is a workflow diagram which illustrates the process undergone in the development of the product and how the Physics and Data Science disciplines worked as one unit. After performing a plethora of experiments, it was found that having the electrodes at least 3cm apart, performing fast eye movements and placing left and right markers for the user, generated a clean, noticeable, signal. Additionally, collecting data from all team members gave enough variation in the data to ensure our classifier is robust and general.</p>
<p>Determining the event detection statistic that best distinguishes between regions of events and non-events involved evaluating the relationship between window size and contrast between the detection metric of said regions. The best performing detection method was found to be zero-crossings; the number of times the signal crosses the zero point (x-axis) per second, with an optimal window length of 0.35s.</p>
<p>Similarly, determining the optimal classifier involved evaluating the relationship between window size and accuracy of the classifier. The most robust classifier was found to be the ‘one extrema classifier’ with 96% accuracy and optimal window size of 0.65s. This classifier smooths the signal using a savitzky-golay filter, then determines if the first turning point is a minimum or maximum. The time taken to execute each classifier (except for KNN) is negligible and thus did not contribute to our choice of classifier.</p>
<p>Re-designing Space Invaders to be controlled using left and right eye movements is not solely useful as an entertaining game with potential commercial success. It is a tool that can act as a learning interface to teach individuals how gesture control performs (as the technology is inevitably integrated into our everyday lives) by using a familiar, nostalgic game such as space invaders. Additional applications include inclusive gaming for those with muscular impairments and building a foundation model for future projects to extend.</p>
<div class="section" id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="motivation-background">
<h2>Motivation &amp; Background<a class="headerlink" href="#motivation-background" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">wavfile</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">scipy.fft</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">fftfreq</span><span class="p">,</span> <span class="n">fftshift</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">catch22</span> <span class="kn">import</span> <span class="n">catch22_all</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">RFECV</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">from</span> <span class="nn">weighted_levenshtein</span> <span class="kn">import</span> <span class="n">lev</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Update this to point to the report folder</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;../&quot;</span>
<span class="c1"># To run all computation, change to True. Otherwise, precomputed files will be loaded instead.</span>
<span class="n">compute_all</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># If running, ensure the following line is commented out. It disables plots for knitting to html purposes. </span>
<span class="o">%</span><span class="k">matplotlib</span> agg

<span class="c1"># Set seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">420</span><span class="p">)</span> 
<span class="c1"># Path to outputs folder</span>
<span class="n">OUT_PATH</span> <span class="o">=</span> <span class="n">PATH</span> <span class="o">+</span> <span class="s2">&quot;report_outputs/&quot;</span>
<span class="c1"># Path to data</span>
<span class="n">IN_PATH</span> <span class="o">=</span> <span class="n">PATH</span> <span class="o">+</span> <span class="s2">&quot;data/&quot;</span>
<span class="c1"># Path to other file dependencies</span>
<span class="n">DEP_PATH</span> <span class="o">=</span> <span class="n">PATH</span> <span class="o">+</span> <span class="s2">&quot;requirements/other_files/&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Over the past two decades, profound advancements in technology such as facial recognition, gesture control, virtual assistants and other instances of machine learning have gradually been integrated into everyday life. With virtual reality worth over $21 billion alone <span id="id1">[<a class="reference internal" href="#id8">VR21</a>]</span>, the gaming industry is evidently undergoing a similar transformation. Such financial success is reason enough to design and implement a game that is similarly controlled by one of these technological advancements. This project involves using gesture control, an instance of one of these technological advancements, to re-develop Space Invaders, the iconic 80’s game which grossed an equivalent of $13 billion <span id="id2">[<a class="reference internal" href="#id9">con21</a>]</span>.</p>
<p>Our desired product is the nostalgic game of Space Invaders, with the spaceship  alternatively controlled by left and right eye movements. These movements are represented by signals generated by the Backyard Brains Spiker Box <span id="id3">[<a class="reference internal" href="#id10">BYB</a>]</span>. The creation of such a game is motivated by the financial success of games such as Pokemon Go which used augmented reality to re-develop the themes and goals of the popular video game series, Pokemon. Our target market is anyone interested in leading technologies and gaming, akin to PokemonGo’s and the original Space Invaders audience. A short survey was conducted and out of 33 people, 85% said they would be interested in this version of Space Invaders. This demonstrates potential commercial success with a remastered launch.</p>
<p>The fundamental aim of this project is to accurately and efficiently detect eye movements, and distinguish between left and right signals. This becomes an arduous task if solely Physics or Data Science is used to implement this project. By integrating these disciplines, the task. The workflow diagram in <a class="reference internal" href="#flow"><span class="std std-numref">Fig. 1</span></a> visually explains the role of each discipline, and how the success of the final product depends on the integration of these sciences. In particular, the Physics discipline is responsible for the experimental design and collection of data, to generate a clean, noticeable signal that is representative of a larger group of people. The Data Science discipline is responsible for implementing code that reads this data, searches for the occurrence of a movement and classifies the specific gesture. Additionally, the integrated knowledge and skills of the Physics and Data Science disciplines led to designing and implementing a method that evaluates the performance of the code in terms of accuracy and efficiency of detection and classification.</p>
<p>Thus, using the skills and knowledge of Physics and Data Science, a well-tested gesture controlled version of Space invaders can be developed.</p>
<div class="figure align-default" id="flow">
<a class="reference internal image-reference" href="_images/flow.png"><img alt="_images/flow.png" src="_images/flow.png" style="width: 708.9px; height: 911.4px;" /></a>
<p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">Workflow diagram illustrating the process undergone by both Physics and Data Science disciplines in the re-developemnt of the game Space Invaders.</span><a class="headerlink" href="#flow" title="Permalink to this image">¶</a></p>
</div>
<!-- reference by {numref}`flow` --></div>
<div class="section" id="experimentation-data-collection">
<h2>Experimentation &amp; Data Collection<a class="headerlink" href="#experimentation-data-collection" title="Permalink to this headline">¶</a></h2>
<p>In reference to <a class="reference internal" href="#flow"><span class="std std-numref">Fig. 1</span></a>, the first step in the re-development of Space Invaders requires experimenting with the Spikerbox to collect data which is representative application of the game. The aim of experimentation is to define characteristic signal signatures (such as left and right eye movements) and determine how these change as physical aspects of the experimental design vary.</p>
<div class="section" id="physical-experiments-performed-findings">
<h3>Physical experiments performed &amp; Findings<a class="headerlink" href="#physical-experiments-performed-findings" title="Permalink to this headline">¶</a></h3>
<p>The following sections detail the plethora of experiments performed and specifically what each test was exploring.</p>
<div class="section" id="general-eye-movements">
<h4>General eye movements<a class="headerlink" href="#general-eye-movements" title="Permalink to this headline">¶</a></h4>
<p>The first experiment is to determine if distinguishing between left and right eye movements is possible. Two electrodes were placed above the eyebrow of a team members eye and they were instructed to look forward. Then, the team member moved their eyes from the middle position, to the left or right, then immediately back to the middle-position.  (insert figure reference to signal graph) illustrates that while the signal shape of left and right eye movements appears the same, the polarity of the signals is inverted.</p>
</div>
<div class="section" id="varying-speed-of-eye-movements">
<h4>Varying speed of eye movements<a class="headerlink" href="#varying-speed-of-eye-movements" title="Permalink to this headline">¶</a></h4>
<p>With the same experimental set up, the team member is now instructed to vary the speed at which they look towards the left or right. It was found that when eye movements were too slow, the signal associated with looking from middle to the left became separated from that when looking from the left back to the middle. In fact, the differences between the signals had the same shape yet opposing polarity, much like that in the first experiment. However, with fast eye-movements, these two separate signals became one, yielding the same output as the first experiment.</p>
</div>
<div class="section" id="varying-distance-of-eye-movements">
<h4>Varying distance of eye movements<a class="headerlink" href="#varying-distance-of-eye-movements" title="Permalink to this headline">¶</a></h4>
<p>Now, the team member was asked to perform normal left-middle and right-middle eye movements such as in the first experiment, however, with each iteration they must look slightly further away from the middle position. The design of this experiment involved placing objects equally distant apart which acted as targets to look. It was found that if the eyes movement a small distance away from the middle position, a signal was barely detecable. This distance was not quantified, as we will see it is completely dependent on the individual performing the experiment. As the eyes moved further away from the beggining position, the amplitude of the signal grew accordingly.</p>
</div>
<div class="section" id="electrode-placement">
<h4>Electrode Placement<a class="headerlink" href="#electrode-placement" title="Permalink to this headline">¶</a></h4>
<p>The only experimental feature that is now different to the original experiment is the configuration of the electrode placements. It was found that placing the electrode vertically across tehe eye as opposed to horizontally no longer generates a distinguishabel signal for aleft and right eye movements. Instead, the best movement associated with this placement is up and down.</p>
<p>Additionally, altering the distance between the electrode placement was tested about found that electrodes placed much closer than arounf 3cm to each other failed to generate a noticable, distinguishable signal with left and right eye movements.</p>
</div>
<div class="section" id="changing-individual-changing-boxes">
<h4>Changing Individual &amp; Changing Boxes<a class="headerlink" href="#changing-individual-changing-boxes" title="Permalink to this headline">¶</a></h4>
<p>As experimental equipment was swapped, such as the SpikerBox itself, electrodes and connecting wires, or there there is a new team member collecting the data, the dignal generated was subject to change. Such changes included variation in noise, signal amplitude and in worst cases a completely different signal signature in general.</p>
</div>
<div class="section" id="determining-how-the-signal-changes-with-natural-movement">
<h4>Determining how the signal changes with natural Movement<a class="headerlink" href="#determining-how-the-signal-changes-with-natural-movement" title="Permalink to this headline">¶</a></h4>
<p>Using the same experimental set up as the first experiment, the user was asked to sit still and blink naturally, then move their face (smile, raise tehir eyebrows, shake their head, scrunch their nose etc.). Occasionally the blinks were small, detectable peaks in the signal. Whereas movement of the muscles in their face cause a dramatic increase in noise and sometimes amplitude.</p>
</div>
</div>
<div class="section" id="immediate-implications-of-findings">
<h3>Immediate Implications of Findings<a class="headerlink" href="#immediate-implications-of-findings" title="Permalink to this headline">¶</a></h3>
<p>From our above findings, we can immediately adapt the final experimental design to ensure the cleanest and most noticable signal is generated.</p>
<ul class="simple">
<li><p>Throughout the rest of the experiment data was collected by placing the electrodes at least 3cm apart in a horizontal configuration above the eyebrow.</p></li>
<li><p>The speed the user moves their eyes are fast, however, these movements are separated by minimum time intervals to prevent merging the signals.</p></li>
<li><p>Throughout data collection, markers were placed on the left and right of the user to act as a target, ensuring they move their eyes far enough to generate a strong signal.</p></li>
<li><p>Data was collected from more than one individual to ensure the dataset it representative of a larger group.</p></li>
<li><p>To overcome the issue due to noise it would be appropriate duing pre-processing to use a noise filter.</p></li>
<li><p>To overcome the issue due to changing signal amplitude, pre-processing of the signal should additionally involve normalisation or calibration.</p></li>
</ul>
</div>
<div class="section" id="sample-collection-of-data">
<h3>Sample Collection of Data<a class="headerlink" href="#sample-collection-of-data" title="Permalink to this headline">¶</a></h3>
<p>We have prepared 8 wave files (.wav) to the following specifications:</p>
<ul class="simple">
<li><p>50 seconds in length</p></li>
<li><p>First 5 seconds is a calibration period - no movements performed</p></li>
<li><p>A sequence of left and right movements are performed for the remaining 45 seconds</p></li>
<li><p>Each file is accompanied with a labels textfile (.txt) containing the timestamps and labels of every event in the wavefile. ‘1’ corresponds to a left eye movement, and ‘2’ corresponds to a right eye movement.</p></li>
<li><p>Each .wav file has a range of [0, 1024], but are centred to [-512, 512] within the <code class="docutils literal notranslate"><span class="pre">load_data</span></code> function defined below.</p></li>
</ul>
<p>Two of the eight files were randomly selected as the test set, and the rest were assigned to the training set.</p>
<div class="cell tag_hide-input tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shift_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">512</span><span class="p">):</span>
    <span class="n">waves</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
        <span class="c1"># Load in wave file</span>
        <span class="n">samprate</span><span class="p">,</span> <span class="n">wav_array</span> <span class="o">=</span> <span class="n">wavfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">file</span><span class="o">+</span><span class="s2">&quot;.wav&quot;</span><span class="p">)</span>
        <span class="n">wav_array</span> <span class="o">=</span> <span class="n">wav_array</span><span class="o">*</span><span class="n">scale_factor</span>
        <span class="n">wav_array</span> <span class="o">+=</span> <span class="n">shift_factor</span>
        <span class="n">waves</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">wav_array</span>
        <span class="c1"># Load in label file</span>
        <span class="n">labels_dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">file</span><span class="o">+</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">labels_dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="n">labels_dat</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;R&quot;</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_dat</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_dat</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">waves</span><span class="p">)</span><span class="si">}</span><span class="s2"> wavefiles:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">waves</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="k">return</span> <span class="n">waves</span><span class="p">,</span> <span class="n">labels</span>

<span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;data1&quot;</span><span class="p">,</span> <span class="s2">&quot;data2&quot;</span><span class="p">,</span> <span class="s2">&quot;data3&quot;</span><span class="p">,</span> <span class="s2">&quot;data4&quot;</span><span class="p">,</span> <span class="s2">&quot;data5&quot;</span><span class="p">,</span> <span class="s2">&quot;data6&quot;</span><span class="p">,</span> <span class="s2">&quot;data7&quot;</span><span class="p">,</span> <span class="s2">&quot;data8&quot;</span><span class="p">]</span>

<span class="c1"># Randomly select two files for the test set, remainder as training</span>
<span class="n">test_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">training_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_files</span><span class="p">))</span>

<span class="c1"># Training Data</span>
<span class="n">waves</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
    <span class="n">IN_PATH</span><span class="p">,</span> <span class="n">training_files</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shift_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">512</span><span class="p">)</span>

<span class="c1"># Test Data</span>
<span class="n">test_waves</span><span class="p">,</span> <span class="n">test_labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
    <span class="n">IN_PATH</span><span class="p">,</span> <span class="n">test_files</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shift_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">512</span><span class="p">)</span>

<span class="c1"># Define Sample Rate: 10,000 Hz</span>
<span class="n">samprate</span> <span class="o">=</span> <span class="mi">10_000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully loaded 6 wavefiles:
data1
data2
data3
data4
data6
data8
Successfully loaded 2 wavefiles:
data5
data7
</pre></div>
</div>
</div>
</div>
<p>Next, we convert the singular timestamps in the labels dataframe to the time interval of the entire event. There was a minor data quality issue with some of the timestamps which caused some files to have slightly shifted timestamps. To fix this, we went through and manually defined the interval for each file (the time to add before and after the timestamp to get the desired interval). We did this once to encompass the entire wave signal, and another time to only cover the first hump of the signal.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First hump</span>
<span class="n">time_buffers_hump</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;data1&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">),</span>
    <span class="s2">&quot;data2&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">),</span>
    <span class="s2">&quot;data3&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">),</span>
    <span class="s2">&quot;data4&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
    <span class="s2">&quot;data5&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
    <span class="s2">&quot;data6&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
    <span class="s2">&quot;data7&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
    <span class="s2">&quot;data8&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Whole wave</span>
<span class="n">time_buffers_whole</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;data1&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">),</span>
    <span class="s2">&quot;data2&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">),</span>
    <span class="s2">&quot;data3&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">),</span>
    <span class="s2">&quot;data4&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">),</span>
    <span class="s2">&quot;data5&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">),</span>
    <span class="s2">&quot;data6&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">),</span>
    <span class="s2">&quot;data7&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">),</span>
    <span class="s2">&quot;data8&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="streaming-algorithm-design">
<h3>Streaming Algorithm Design<a class="headerlink" href="#streaming-algorithm-design" title="Permalink to this headline">¶</a></h3>
<p>First, we must design the basic structure of our streaming algorithm. The algorithm will consist of two parts, the first is event detection, and the second is classification. As the streaming data comes in, we will only keep a window of fixed length in memory, effectively behaving as a sliding window at the front of the stream. This window updates in discrete intervals of some <em>buffer length</em>, and we will deem this window the <em>classification window</em>.</p>
<p>Within that classification window, we will fix another smaller window that slides along with the classification window. This subset of the classification window is what we will test an event criterion on, and is hence called the <em>detection window</em>.</p>
<p>Each time the window is updated by the stream, the event criterion is tested on the detection window. To minimise false positives, that criterion will need to pass a set number of times, dictated by the <code class="docutils literal notranslate"><span class="pre">consecutive_event_triggers</span></code> parameter.</p>
<p>Once the event criterion has passed <code class="docutils literal notranslate"><span class="pre">consecutive_event_triggers</span></code> times, we pass the classification window to the classifier algorithm and block the classifier from detecting another event. When the event criterion has failed <code class="docutils literal notranslate"><span class="pre">consecutive_nonevent_reset</span></code> times, we prime the streaming algorithm to predict events again. This is to stop the algorithm from detecting the same event twice.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function that reads in the kth &lt;inputBufferSize&gt; sized segment of the array</span>
<span class="c1"># Simulates streaming condition on recorded wavefiles.</span>
<span class="k">def</span> <span class="nf">read_arduinbro</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">inputBufferSize</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">inputBufferSize</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">wav_array</span><span class="p">[(</span><span class="n">inputBufferSize</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="p">)):(</span><span class="n">inputBufferSize</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">wav_array</span><span class="p">[(</span><span class="n">inputBufferSize</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="p">))::]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">streaming_classifier</span><span class="p">(</span>
        <span class="n">wav_array</span><span class="p">,</span>                             <span class="c1"># Either the array from file (or ser if live = True)</span>
        <span class="n">samprate</span><span class="p">,</span>
        <span class="n">classifier</span><span class="p">,</span>
        <span class="n">input_buffer_size_sec</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>           <span class="c1"># Buffer size in seconds</span>
        <span class="n">store_events</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>                  <span class="c1"># Whether to return the classification window array for</span>
                                                   <span class="c1"># debugging purposes</span>
        <span class="n">store_times</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>                   <span class="c1"># Store time taken for each classification</span>
        <span class="n">live</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">FIFO_filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_FIFO_msg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

        <span class="n">classifier_params</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">classification_window_size_sec</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="c1"># Total detection window [s]</span>

        <span class="n">calibration_window_size_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>       <span class="c1"># The length of the calibration period to define the threshold</span>
        <span class="n">calibration_statistic_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Function that calculates the calibration statistic</span>

        <span class="n">detection_window_size_sec</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">detection_window_offset_sec</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">event_test_statistic_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Function that calculates the test statistic</span>
        <span class="n">event_threshold_factor</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>          <span class="c1"># The scale factor of the calibration stat that will become</span>
                                                   <span class="c1"># the threshold</span>
        <span class="n">flip_threshold</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>                <span class="c1"># Threshold is a lower bound if true, upper bound if false</span>
        <span class="n">consecutive_event_triggers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>        <span class="c1"># How many threshold triggers need to occur in a row for an </span>
                                                   <span class="c1"># event to be called</span>
        <span class="n">consecutive_nonevent_reset</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># How many threshold failures need to occur in a row for the</span>
                                                   <span class="c1"># classifier to be primed for a new event</span>
        <span class="p">):</span>

    <span class="c1"># Connect to fifo</span>
    <span class="k">if</span> <span class="n">FIFO_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fifo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">FIFO_filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">store_events</span><span class="p">:</span>
        <span class="n">predictions_storage</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">store_times</span><span class="p">:</span>
        <span class="n">classification_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">predictions_timestamps</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Initialise variables</span>
    <span class="n">N_loops_over_window</span> <span class="o">=</span> <span class="n">classification_window_size_sec</span><span class="o">//</span><span class="n">input_buffer_size_sec</span>
    <span class="n">input_buffer_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">input_buffer_size_sec</span> <span class="o">*</span> <span class="n">samprate</span><span class="p">))</span>
    <span class="n">detection_window_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">detection_window_offset_sec</span> <span class="o">*</span> <span class="n">samprate</span><span class="p">))</span>
    <span class="n">detection_window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">detection_window_size_sec</span> <span class="o">*</span> <span class="n">samprate</span><span class="p">))</span>
    
    <span class="c1"># Initialise Calibration</span>
    <span class="n">calibrate</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">N_loops_calibration</span> <span class="o">=</span> <span class="n">calibration_window_size_sec</span><span class="o">//</span><span class="n">input_buffer_size_sec</span>

    <span class="c1"># Initialise Event History</span>
    <span class="n">num_event_history</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">consecutive_event_triggers</span><span class="p">,</span>
                            <span class="n">consecutive_nonevent_reset</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
    <span class="n">event_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">num_event_history</span><span class="p">)</span>

    <span class="c1"># Determine length of stream</span>
    <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
        <span class="n">N_loops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">)</span><span class="o">/</span><span class="n">samprate</span>
        <span class="n">N_loops</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_time</span><span class="o">*</span><span class="n">samprate</span><span class="p">)</span><span class="o">//</span><span class="n">input_buffer_size</span>

    <span class="c1"># Prime the classifier for new event</span>
    <span class="n">primed</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1">### Start stream ###</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">N_loops</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">read_arduino</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span><span class="n">input_buffer_size</span><span class="p">)</span>
            <span class="n">data_temp</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_temp</span> <span class="o">=</span> <span class="n">read_arduinbro</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">input_buffer_size</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">N_loops_over_window</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data_cal</span> <span class="o">=</span> <span class="n">data_temp</span>
                <span class="n">data_window</span> <span class="o">=</span> <span class="n">data_temp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_temp</span><span class="p">,</span> <span class="n">data_window</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">calibrate</span><span class="p">:</span>
                    <span class="n">data_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_temp</span><span class="p">,</span> <span class="n">data_cal</span><span class="p">)</span>
            <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">data_window</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data_temp</span><span class="p">))</span>
            <span class="n">data_window</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data_temp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_temp</span>
            <span class="k">if</span> <span class="n">calibrate</span><span class="p">:</span>
                <span class="n">data_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_temp</span><span class="p">,</span><span class="n">data_cal</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">N_loops_calibration</span><span class="p">):</span>
                    <span class="n">cal_stat</span> <span class="o">=</span> <span class="n">calibration_statistic_function</span><span class="p">(</span><span class="n">data_cal</span><span class="p">)</span>
                    <span class="n">event_threshold</span> <span class="o">=</span> <span class="n">cal_stat</span><span class="o">*</span><span class="n">event_threshold_factor</span>
                    <span class="n">calibrate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">continue</span>
        <span class="c1"># Event Detection</span>
        <span class="c1"># Take detection window from classification window</span>
        
        <span class="n">interval</span> <span class="o">=</span> <span class="n">data_window</span><span class="p">[</span><span class="n">detection_window_offset</span><span class="p">:(</span><span class="n">detection_window_offset</span> <span class="o">+</span> <span class="n">detection_window_size</span><span class="p">)]</span> 
        <span class="n">test_stat</span> <span class="o">=</span> <span class="n">event_test_statistic_function</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span> <span class="c1"># Calculate test stat </span>
                
        <span class="c1"># Test threshold</span>
        <span class="k">if</span> <span class="n">flip_threshold</span><span class="p">:</span>
            <span class="n">is_event</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_stat</span> <span class="o">&lt;</span> <span class="n">event_threshold</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_event</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_stat</span> <span class="o">&gt;</span> <span class="n">event_threshold</span><span class="p">)</span>
        
        <span class="c1"># Record History</span>
        <span class="n">event_history</span><span class="p">[</span><span class="mi">1</span><span class="p">::]</span> <span class="o">=</span> <span class="n">event_history</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">event_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_event</span>
        
        <span class="c1"># if event, pass window to classifier</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">event_history</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">consecutive_event_triggers</span><span class="p">])</span> <span class="ow">and</span> <span class="n">primed</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">(</span><span class="n">data_window</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="o">**</span><span class="n">classifier_params</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">store_times</span><span class="p">:</span>
                <span class="n">classification_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">store_events</span><span class="p">:</span>
                <span class="n">predictions_storage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_window</span><span class="p">)</span>
                        
            <span class="c1"># Record prediction and time interval of event</span>
            <span class="n">predictions</span> <span class="o">+=</span> <span class="n">prediction</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">input_buffer_size_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">classification_window_size_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">predictions_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">))</span>

            <span class="c1"># Pipe it up</span>
            <span class="k">if</span> <span class="n">FIFO_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">create_FIFO_msg</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            
            <span class="c1"># Unprime</span>
            <span class="n">primed</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Check if condition for priming has been met</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">event_history</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">consecutive_nonevent_reset</span><span class="p">]):</span>
            <span class="n">primed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">FIFO_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fifo</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">store_events</span> <span class="ow">and</span> <span class="n">store_times</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_timestamps</span><span class="p">,</span> <span class="n">predictions_storage</span><span class="p">,</span> <span class="n">classification_times</span>
    <span class="k">elif</span> <span class="n">store_events</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_timestamps</span><span class="p">,</span> <span class="n">predictions_storage</span>
    <span class="k">elif</span> <span class="n">store_times</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_timestamps</span><span class="p">,</span> <span class="n">classification_times</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_timestamps</span>
                  
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="optimisation">
<h2>Optimisation<a class="headerlink" href="#optimisation" title="Permalink to this headline">¶</a></h2>
<p>We optimise the streaming algorithm in two dependent stages. The first stage is to optimise event detection by choosing the best test statistic and threshold to apply over the detection window. The test statistic will be the statistic that maximises the contrast between event and non-event regions, and the threshold will be the threshold that maximises the F-score on the training set.</p>
<p>When our algorithm is effective at distinguishing events from non-events, we will use the optimised event detection method to optimise our classifiers on the training set. Once all classifiers are optimised, we will choose the classifier with the best accuracy on the test set based on a levenshtein distance weighted to reflect what is most desirable for its Space Invaders use.</p>
<div class="section" id="event-detection-to-do">
<h3>Event Detection TO DO<a class="headerlink" href="#event-detection-to-do" title="Permalink to this headline">¶</a></h3>
<p>(write lil nicer) Hypothesis from physics perspective: plotting contrast against window length we expect a peak which is the optimal point, taking the appearance of normalisation curve. Thus, two pieces of information (best metric and optimal window length) can be extracted.</p>
<div class="section" id="test-statistic">
<h4>Test Statistic<a class="headerlink" href="#test-statistic" title="Permalink to this headline">¶</a></h4>
<p>The first component to optimising event detection is to choose the best test statistic to be applied over the detection window. To do this, we first define 5 possible candidates for the test statistic. These candidates were chosen because they were deemed likely to be effective in distinguishing events from non-events.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define Test Stat Functions</span>

<span class="c1"># due to their sine wave-like shape, events have a larger range than non-events</span>
<span class="k">def</span> <span class="nf">ts_range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># the range but using the middle half of the distribution to reduce influence from outliers</span>
<span class="k">def</span> <span class="nf">ts_IQR</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># events have high peaks due to their shape compared to non-events</span>
<span class="k">def</span> <span class="nf">ts_abs_max</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># non-events cross the zero line (x-axis) often due to noise, </span>
<span class="c1"># while events have long periods over/under the zero line</span>
<span class="k">def</span> <span class="nf">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">::]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Fourier transforms can distinguish between events and non-events due to </span>
<span class="k">def</span> <span class="nf">ts_max_frequency</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">samprate</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">samprate</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>
    <span class="c1"># Num samples</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">yf</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">xf</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xf</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Sxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Sxx</span><span class="p">)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">maximum</span><span class="o">/</span><span class="mi">5</span><span class="p">;</span>
    <span class="n">maximum_Freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Sxx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># max frequency for each time</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">maximum_Freqs</span><span class="p">)</span>

<span class="n">tfn_candidates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Range&quot;</span><span class="p">:</span> <span class="n">ts_range</span><span class="p">,</span>
                  <span class="s2">&quot;IQR&quot;</span><span class="p">:</span> <span class="n">ts_IQR</span><span class="p">,</span>
                  <span class="s2">&quot;SD&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">,</span>
                  <span class="s2">&quot;Absolute Max&quot;</span><span class="p">:</span> <span class="n">ts_abs_max</span><span class="p">,</span>
                  <span class="s2">&quot;Zero Crossings&quot;</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">,</span>
                  <span class="s2">&quot;Fourier&quot;</span><span class="p">:</span> <span class="n">ts_max_frequency</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluation-metric-contrast">
<h4>Evaluation Metric (Contrast)<a class="headerlink" href="#evaluation-metric-contrast" title="Permalink to this headline">¶</a></h4>
<p>To choose the best test statistic from the candidates, we first calculate a series of test statistics using a sliding window over each training file. Next, we define an evaluation metric called <em>contrast</em>. Essentially, contrast is the absolute value of the Welch’s t-test statistic between the set of test statistics for event regions, and the set of test statistics for non-event regions. It is defined by the following formula:</p>
<div class="math notranslate nohighlight" id="equation-contrast">
<span class="eqno">(1)<a class="headerlink" href="#equation-contrast" title="Permalink to this equation">¶</a></span>\[\textit{contrast}(E, E^*) = \frac{|\bar{E} - \bar{E^*}|}{\sqrt{\frac{\sigma_E^2}{N_E} + \frac{\sigma_{E^*}^2}{N_{E^*}}}}\]</div>
<!-- reference it by {eq}`contrast` -->
<p>where <span class="math notranslate nohighlight">\(E\)</span> is the set of test statistics calculated over event regions, <span class="math notranslate nohighlight">\(E^*\)</span> is the non-event region test statistics, and <span class="math notranslate nohighlight">\(\bar{k}\)</span>, <span class="math notranslate nohighlight">\(\sigma_k\)</span> and <span class="math notranslate nohighlight">\(N_k\)</span> are the mean, standard deviation and number of elements in set <span class="math notranslate nohighlight">\(k\)</span> respectively.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">contrast</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">non_events</span><span class="p">):</span> 
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">non_events</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">non_events</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">non_events</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">pooled_sd</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we perform a gridsearch varying the window length from 0 to 2 seconds and calculating the contrast of each test statistic each window length. The results are shown in <a class="reference internal" href="#contrast"><span class="std std-numref">Fig. 2</span></a>.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_event_regions</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">labels_dat</span><span class="p">,</span> <span class="n">time_buffer</span><span class="p">):</span>
    <span class="n">before_buffer</span> <span class="o">=</span> <span class="n">time_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">after_buffer</span> <span class="o">=</span> <span class="n">time_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">time_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">))</span><span class="o">/</span><span class="n">samprate</span>

    <span class="n">left_events_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">time_seq</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">labels_dat</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">labels_dat</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">]:</span>
        <span class="n">left_events_bool</span> <span class="o">=</span> <span class="p">(((</span><span class="n">time_seq</span> <span class="o">&gt;</span> <span class="n">time</span> <span class="o">-</span> <span class="n">before_buffer</span><span class="p">)</span> <span class="o">&amp;</span> 
                             <span class="p">(</span><span class="n">time_seq</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">+</span><span class="n">after_buffer</span><span class="p">))</span> <span class="o">|</span> <span class="n">left_events_bool</span><span class="p">)</span>

    <span class="n">right_events_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">time_seq</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">labels_dat</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">labels_dat</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">]:</span>
        <span class="n">right_events_bool</span> <span class="o">=</span> <span class="p">(((</span><span class="n">time_seq</span> <span class="o">&gt;</span> <span class="n">time</span> <span class="o">-</span> <span class="n">before_buffer</span><span class="p">)</span> <span class="o">&amp;</span> 
                              <span class="p">(</span><span class="n">time_seq</span> <span class="o">&lt;</span> <span class="n">time</span> <span class="o">+</span> <span class="n">after_buffer</span><span class="p">))</span> <span class="o">|</span> <span class="n">right_events_bool</span><span class="p">)</span>

    <span class="n">event_bool</span> <span class="o">=</span> <span class="n">left_events_bool</span> <span class="o">|</span> <span class="n">right_events_bool</span>
    <span class="k">return</span> <span class="n">event_bool</span>


<span class="k">def</span> <span class="nf">get_test_stats</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">test_stat_fns</span><span class="p">):</span>
    <span class="n">test_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">test_stat_fns</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">)))</span>
    <span class="n">all_windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">sliding_window_view</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">window_shape</span> <span class="o">=</span> <span class="n">window_size</span><span class="p">)</span>
    <span class="n">all_windows</span> <span class="o">=</span> <span class="n">all_windows</span><span class="p">[::</span><span class="n">step</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_stat_fns</span><span class="p">):</span>
        <span class="n">testicles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">all_windows</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">teste</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">testicles</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">testicles</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">test_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">step</span><span class="p">)::]</span> <span class="o">=</span> <span class="n">teste</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">step</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="p">)]</span>  <span class="o">=</span> <span class="n">teste</span>
    <span class="k">return</span> <span class="n">test_stats</span>


<span class="k">def</span> <span class="nf">get_contrast</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">labels_dat</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">test_stat_fns</span><span class="p">,</span> <span class="n">contrast_fn</span><span class="p">,</span> <span class="n">time_buffer</span><span class="p">):</span>
    <span class="n">test_stats</span> <span class="o">=</span> <span class="n">get_test_stats</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">test_stat_fns</span><span class="p">)</span>
    <span class="n">events_bool</span> <span class="o">=</span> <span class="n">get_event_regions</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">labels_dat</span><span class="p">,</span> <span class="n">time_buffer</span><span class="p">)</span>
    <span class="n">event_test_stats</span> <span class="o">=</span> <span class="n">test_stats</span><span class="p">[:,</span> <span class="n">events_bool</span><span class="p">]</span>           
    <span class="n">non_event_test_stats</span> <span class="o">=</span> <span class="n">test_stats</span><span class="p">[:,</span> <span class="o">~</span><span class="n">events_bool</span><span class="p">]</span>
    <span class="n">contrast_stat</span> <span class="o">=</span> <span class="n">contrast_fn</span><span class="p">(</span><span class="n">event_test_stats</span><span class="p">,</span> <span class="n">non_event_test_stats</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">contrast_stat</span>

    
<span class="k">def</span> <span class="nf">contrast_all_files</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">test_stat_fns</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> 
                       <span class="n">waves</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">contrast_fn</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">time_buffers</span><span class="o">=</span><span class="n">time_buffers_whole</span><span class="p">):</span>   
    <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="o">*</span><span class="n">samprate</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">waves</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">wav_array</span> <span class="o">=</span> <span class="n">waves</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">labels_dat</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="n">cont</span> <span class="o">=</span> <span class="n">get_contrast</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">labels_dat</span><span class="p">,</span>
                         <span class="n">window_size</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">test_stat_fns</span><span class="p">,</span>
                         <span class="n">contrast_fn</span><span class="p">,</span> <span class="n">time_buffers</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">window_size</span><span class="p">),</span> <span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_filename_event_det_opt</span> <span class="o">=</span> <span class="n">OUT_PATH</span> <span class="o">+</span> <span class="s2">&quot;event_detection_optimisation.csv&quot;</span>

<span class="k">if</span> <span class="n">compute_all</span><span class="p">:</span>
    <span class="n">granularity</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">output_filename_event_det_opt</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    <span class="c1"># Clears the file so that the code can be run again.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="k">10</span> == 0:
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">granularity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">contrast_all_files</span><span class="p">(</span>
            <span class="n">output_filename_event_det_opt</span><span class="p">,</span> 
            <span class="n">window_size</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> 
            <span class="n">test_stat_fns</span> <span class="o">=</span> <span class="n">tfn_candidates</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">samprate</span> <span class="o">=</span> <span class="n">samprate</span><span class="p">,</span>
            <span class="n">waves</span> <span class="o">=</span> <span class="n">waves</span><span class="p">,</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">contrast_fn</span> <span class="o">=</span> <span class="n">contrast</span><span class="p">,</span>
            <span class="n">time_buffers</span> <span class="o">=</span> <span class="n">time_buffers_whole</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contrasts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_filename_event_det_opt</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">contrasts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">tfn_candidates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">contrasts_total</span> <span class="o">=</span> <span class="n">contrasts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;window_size&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">tfn_candidates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">contrasts_total</span><span class="o">.</span><span class="n">index</span><span class="o">/</span><span class="n">samprate</span><span class="p">,</span>
             <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">contrasts_total</span><span class="p">[</span><span class="n">stat</span><span class="p">]),</span>
             <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2"> Contrast&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Event Region Contrast vs. Detection Window&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Detection Window Length (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Contrast (t Test Statistic)&quot;</span><span class="p">)</span>
<span class="n">opt_det_window</span> <span class="o">=</span> <span class="n">contrasts_total</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">contrasts_total</span><span class="p">[</span><span class="s2">&quot;Zero Crossings&quot;</span><span class="p">]))]</span><span class="o">/</span><span class="n">samprate</span>
<span class="n">opt_det_window_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">contrasts_total</span><span class="p">[</span><span class="s2">&quot;Zero Crossings&quot;</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">opt_det_window</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opt_det_window_val</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Optimal Point (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">opt_det_window</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">opt_det_window_val</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">opt_det_window_val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opt_det_window</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUT_PATH</span><span class="o">+</span><span class="s2">&quot;contrast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="figure align-default" id="contrast">
<a class="reference internal image-reference" href="_images/contrast.png"><img alt="_images/contrast.png" src="_images/contrast.png" style="width: 525.0px; height: 525.0px;" /></a>
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Contrast of each test statistic as a function of window size. We can see that zero crossings produces the maximum contrast at a window length of 0.35 seconds.</span><a class="headerlink" href="#contrast" title="Permalink to this image">¶</a></p>
</div>
<!-- reference by {numref}`contrast` --></div>
<div class="section" id="threshold-optimisation">
<h4>Threshold Optimisation<a class="headerlink" href="#threshold-optimisation" title="Permalink to this headline">¶</a></h4>
<p>Now that we have determined the best test statistic and its corresponding optimal detection window length, we will use these to determine the optimal threshold for event detection. To do this, we perform yet another gridsearch to maximise <span class="math notranslate nohighlight">\(F_1\)</span>-score. The results are displayed below in <a class="reference internal" href="#threshold"><span class="std std-numref">Fig. 3</span></a>.</p>
<div class="cell tag_hide-input tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_filename_thresh_opt</span> <span class="o">=</span> <span class="n">OUT_PATH</span> <span class="o">+</span> <span class="s2">&quot;threshold_optimisation.csv&quot;</span>

<span class="k">if</span> <span class="n">compute_all</span><span class="p">:</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">output_filename_thresh_opt</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Clear file</span>
    <span class="n">calibration_window_sec</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">for</span> <span class="n">st_scale</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">fps</span><span class="p">,</span> <span class="n">fns</span><span class="p">,</span> <span class="n">tps</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">waves</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_timestamps</span> <span class="o">=</span> <span class="n">streaming_classifier</span><span class="p">(</span>
                <span class="n">waves</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="n">samprate</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="s2">&quot;R&quot;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">0.5</span> <span class="k">else</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span>
                <span class="n">input_buffer_size_sec</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">classification_window_size_sec</span> <span class="o">=</span> <span class="n">opt_det_window</span><span class="p">,</span>
                <span class="n">detection_window_size_sec</span> <span class="o">=</span> <span class="n">opt_det_window</span><span class="p">,</span>
                <span class="n">detection_window_offset_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">calibration_window_size_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                <span class="n">calibration_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                <span class="n">event_test_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                <span class="n">event_threshold_factor</span> <span class="o">=</span> <span class="n">st_scale</span><span class="p">,</span> 
                <span class="n">flip_threshold</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                <span class="n">consecutive_event_triggers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                <span class="n">consecutive_nonevent_reset</span> <span class="o">=</span> <span class="mi">10</span> 
            <span class="p">)</span>
            <span class="n">before_buffer</span> <span class="o">=</span> <span class="n">time_buffers_hump</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">after_buffer</span> <span class="o">=</span> <span class="n">time_buffers_hump</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">actual_times</span> <span class="o">=</span> <span class="p">[(</span><span class="n">time</span><span class="o">-</span><span class="n">before_buffer</span><span class="p">,</span> <span class="n">time</span><span class="o">+</span><span class="n">after_buffer</span><span class="p">)</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">]</span>
            <span class="n">actual_leftovers</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">actual_times</span><span class="p">)</span>
            <span class="n">pred_leftovers</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">predictions_timestamps</span><span class="p">)</span>
            <span class="n">tps</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_times</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">act_times</span> <span class="ow">in</span> <span class="n">actual_times</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">act_times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">calibration_window_sec</span><span class="p">:</span>
                    <span class="n">actual_leftovers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">act_times</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">pred_times</span> <span class="ow">in</span> <span class="n">predictions_timestamps</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">act_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pred_times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">act_times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pred_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                        <span class="n">pred_times</span> <span class="ow">in</span> <span class="n">pred_leftovers</span> <span class="ow">and</span> <span class="n">act_times</span> <span class="ow">in</span> <span class="n">actual_leftovers</span><span class="p">):</span>
                        <span class="n">actual_leftovers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">act_times</span><span class="p">)</span>
                        <span class="n">pred_leftovers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pred_times</span><span class="p">)</span>
            <span class="n">tps</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_leftovers</span><span class="p">)</span>
            <span class="n">fns</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_leftovers</span><span class="p">)</span>
            <span class="n">fps</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_leftovers</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">fscore</span> <span class="o">=</span> <span class="n">tps</span><span class="o">/</span><span class="p">(</span><span class="n">tps</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">fns</span><span class="o">+</span><span class="n">fps</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">st_scale</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">%</span><span class="k">10</span> == 0:
            <span class="nb">print</span><span class="p">(</span><span class="n">st_scale</span><span class="p">,</span> <span class="n">fscore</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename_thresh_opt</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st_scale</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">fscore</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_filename_thresh_opt</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">thresholds</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;threshold_factor&quot;</span><span class="p">,</span> <span class="s2">&quot;f_score&quot;</span><span class="p">]</span> 

<span class="n">thresh_factors</span> <span class="o">=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">threshold_factor</span>
<span class="n">f_score_list</span> <span class="o">=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">f_score</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresh_factors</span><span class="p">,</span> <span class="n">f_score_list</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;F-Score vs. Threshold Factor</span><span class="se">\n</span><span class="s2">(Zero Crossings Calibration Statistic)&quot;</span><span class="p">)</span>
<span class="n">opt_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thresh_factors</span><span class="p">[</span><span class="n">f_score_list</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f_score_list</span><span class="p">)])</span>
<span class="n">opt_fscore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f_score_list</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">opt_thresh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opt_fscore</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Optimal Point (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">opt_thresh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">opt_fscore</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">opt_fscore</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opt_thresh</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Threshold Factor&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;F-Score&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUT_PATH</span><span class="o">+</span><span class="s2">&quot;threshold.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="figure align-default" id="threshold">
<a class="reference internal image-reference" href="_images/threshold.png"><img alt="_images/threshold.png" src="_images/threshold.png" style="width: 525.0px; height: 525.0px;" /></a>
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Plot of the F score for different threshold factors on the training set. The threshold is obtained by multiplying the zero crossings of the calibration window (normalised by the length of the window) by the threshold factor. We find the highest F score occurs when the threshold factor is 0.27.</span><a class="headerlink" href="#threshold" title="Permalink to this image">¶</a></p>
</div>
<!-- reference by {numref}`threshold` --></div>
</div>
<div class="section" id="classification-to-do">
<h3>Classification TO DO<a class="headerlink" href="#classification-to-do" title="Permalink to this headline">¶</a></h3>
<p>for physics aspect just mention:</p>
<ul class="simple">
<li><p>again, what we predict the evaluation graph should look like</p></li>
<li><p>we used a signal to filter the noise for one-three prong (mention its a physics thing to do when explaining classifier)</p></li>
</ul>
<div class="section" id="classifiers">
<h4>Classifiers<a class="headerlink" href="#classifiers" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare Classifier Candidates</span>

<span class="c1"># catch22 kNN classifier (using stepwise selected features)</span>
<span class="n">step_csv</span> <span class="o">=</span> <span class="n">DEP_PATH</span><span class="o">+</span><span class="s2">&quot;catch22_step_selected_features.csv&quot;</span>
<span class="n">catch22_step_training_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">step_csv</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">catch22_step_training_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y_labels</span> <span class="o">=</span> <span class="n">catch22_step_training_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   
<span class="n">neigh</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">neigh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_labels</span><span class="p">)</span>

<span class="c1"># &quot;Zeros&quot; classifier</span>
<span class="c1"># returns a list of sub-arrays, grouped by the same consecutive value</span>
<span class="c1"># (in this case they are groups of consecutive 1s or -1s) </span>

<span class="nd">@njit</span> <span class="c1"># numba decorator that performs just-in-time (jit) compilation</span>
<span class="k">def</span> <span class="nf">consecutive</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">stepsize</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>                              
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">stepsize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># looks for the first sequence where the sign doesn&#39;t change for a period of time,</span>
<span class="c1"># checks whether the average height is higher or lower than a threshold then classifies</span>
<span class="nd">@njit</span> 
<span class="k">def</span> <span class="nf">zeroes_classifier</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">downsample_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ave_height</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">consec_seconds</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
    <span class="n">arr_ds</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">downsample_rate</span><span class="p">]</span>
    <span class="n">arr_sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">)</span>            
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">split_arrays</span> <span class="o">=</span> <span class="n">consecutive</span><span class="p">(</span><span class="n">arr_sign</span><span class="p">)</span>  
    <span class="k">for</span> <span class="n">sub_arr</span> <span class="ow">in</span> <span class="n">split_arrays</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">consec_seconds</span> <span class="o">*</span> <span class="n">samprate</span> <span class="o">/</span> <span class="n">downsample_rate</span><span class="p">:</span>  <span class="c1"># RHS converts seconds to number of samples</span>
            <span class="c1"># if there were &#39;consec_seconds&#39; seconds of no zero-crossings,</span>
            <span class="c1"># check if the average height is bigger than &#39;ave_height&#39;</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="n">ave_height</span><span class="p">:</span>          
                <span class="k">return</span> <span class="s1">&#39;R&#39;</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">ave_height</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;L&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_arr</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;_&#39;</span>   

<span class="c1"># calculates the 5 features selected from catch22, find the 5 nearest neighbours </span>
<span class="c1"># calculated using Euclidean distance, then selects the majority classification</span>
<span class="k">def</span> <span class="nf">catch22_knn_classifier</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">downsample_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">arr_ds</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">downsample_rate</span><span class="p">]</span>
    <span class="n">arr_list</span> <span class="o">=</span> <span class="n">arr_ds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">feature_one</span> <span class="o">=</span> <span class="n">catch22</span><span class="o">.</span><span class="n">DN_HistogramMode_5</span><span class="p">(</span><span class="n">arr_list</span><span class="p">)</span>
    <span class="n">feature_two</span> <span class="o">=</span> <span class="n">catch22</span><span class="o">.</span><span class="n">SB_BinaryStats_mean_longstretch1</span><span class="p">(</span><span class="n">arr_list</span><span class="p">)</span>
    <span class="n">feature_three</span> <span class="o">=</span> <span class="n">catch22</span><span class="o">.</span><span class="n">FC_LocalSimple_mean1_tauresrat</span><span class="p">(</span><span class="n">arr_list</span><span class="p">)</span>
    <span class="n">feature_four</span> <span class="o">=</span> <span class="n">catch22</span><span class="o">.</span><span class="n">DN_OutlierInclude_p_001_mdrmd</span><span class="p">(</span><span class="n">arr_list</span><span class="p">)</span>
    <span class="n">feature_five</span> <span class="o">=</span> <span class="n">catch22</span><span class="o">.</span><span class="n">SP_Summaries_welch_rect_area_5_1</span><span class="p">(</span><span class="n">arr_list</span><span class="p">)</span>
    <span class="n">test_features</span> <span class="o">=</span> <span class="p">[[</span><span class="n">feature_one</span><span class="p">,</span> <span class="n">feature_two</span><span class="p">,</span> <span class="n">feature_three</span><span class="p">,</span> <span class="n">feature_four</span><span class="p">,</span> <span class="n">feature_five</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">neigh</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_features</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>                    

<span class="c1"># wave is smoothed using Savitzky-Golay Filter, then decides whether the event is</span>
<span class="c1"># a left or right depending on whether the first turning point is a max or min</span>
<span class="k">def</span> <span class="nf">one_pronged_smoothing_classifier</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">downsample_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">window_size_seconds</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">max_loops</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">arr_ds</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">downsample_rate</span><span class="p">]</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">samprate</span><span class="o">/</span><span class="n">downsample_rate</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>

    <span class="c1"># Smooth wave</span>
    <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_size_seconds</span><span class="o">*</span><span class="n">samprate</span><span class="o">/</span><span class="n">downsample_rate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">filtered_arr</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Indices of positive maxima</span>
    <span class="n">max_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">filtered_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">max_vals</span> <span class="o">=</span> <span class="n">filtered_arr</span><span class="p">[</span><span class="n">max_locs</span><span class="p">]</span>
    <span class="n">max_locs</span> <span class="o">=</span> <span class="n">max_locs</span><span class="p">[</span><span class="n">max_vals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Indices of negative minima</span>
    <span class="n">min_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">filtered_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">min_vals</span> <span class="o">=</span> <span class="n">filtered_arr</span><span class="p">[</span><span class="n">min_locs</span><span class="p">]</span>
    <span class="n">min_locs</span> <span class="o">=</span> <span class="n">min_locs</span><span class="p">[</span><span class="n">min_vals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="n">max_min_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_locs</span><span class="p">,</span> <span class="n">min_locs</span><span class="p">)</span>    <span class="c1"># Appended indices</span>
    <span class="n">max_min_values</span> <span class="o">=</span> <span class="n">filtered_arr</span><span class="p">[</span><span class="n">max_min_locs</span><span class="p">]</span>     <span class="c1"># Values of above indices    </span>
    <span class="n">abs_max_min_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_min_values</span><span class="p">)</span>     <span class="c1"># Absolute value of those values</span>

    <span class="c1"># A vector with a length equal to the number of minimums: all &#39;-1&#39; to say minimum</span>
    <span class="n">numMin</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">min_locs</span><span class="p">)</span>    
    <span class="n">numMax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">max_locs</span><span class="p">)</span>     <span class="c1"># Same for max, but with &#39;1&#39;</span>
    <span class="n">isMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numMax</span><span class="p">,</span> <span class="n">numMin</span><span class="p">)</span>
    <span class="n">val_and_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">abs_max_min_values</span><span class="p">,</span> <span class="n">max_min_locs</span><span class="p">,</span> <span class="n">isMin</span><span class="p">])</span>
    <span class="c1"># Sort the magnitudes of the extrema in descending order (-1 indicates descending)</span>
    <span class="n">val_and_idx_sorted</span> <span class="o">=</span> <span class="n">val_and_idx</span><span class="p">[</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">val_and_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">val_and_idx_sorted</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val_and_idx_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;L&#39;</span>
        <span class="k">elif</span> <span class="n">val_and_idx_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;R&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;_&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val_and_idx_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;L&#39;</span>
        <span class="k">elif</span> <span class="n">val_and_idx_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;R&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;_&quot;</span>

<span class="c1"># wave is smoothed using Savitzky-Golay Filter, then decides whether the event is</span>
<span class="c1"># a left or right depending on the order of the maximum and minimum turning points</span>
<span class="k">def</span> <span class="nf">two_pronged_smoothing_classifier</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">downsample_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                                       <span class="n">window_size_seconds</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">max_loops</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">arr_ds</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">downsample_rate</span><span class="p">]</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">samprate</span><span class="o">/</span><span class="n">downsample_rate</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>

    <span class="c1"># Smooth wave</span>
    <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_size_seconds</span><span class="o">*</span><span class="n">samprate</span><span class="o">/</span><span class="n">downsample_rate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">filtered_arr</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Indices of positive maxima</span>
    <span class="n">max_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">filtered_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">max_vals</span> <span class="o">=</span> <span class="n">filtered_arr</span><span class="p">[</span><span class="n">max_locs</span><span class="p">]</span>
    <span class="n">max_locs</span> <span class="o">=</span> <span class="n">max_locs</span><span class="p">[</span><span class="n">max_vals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Indices of negative minima</span>
    <span class="n">min_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">filtered_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">min_vals</span> <span class="o">=</span> <span class="n">filtered_arr</span><span class="p">[</span><span class="n">min_locs</span><span class="p">]</span>
    <span class="n">min_locs</span> <span class="o">=</span> <span class="n">min_locs</span><span class="p">[</span><span class="n">min_vals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="n">max_min_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_locs</span><span class="p">,</span> <span class="n">min_locs</span><span class="p">)</span>    <span class="c1"># Appended indices</span>
    <span class="n">max_min_values</span> <span class="o">=</span> <span class="n">filtered_arr</span><span class="p">[</span><span class="n">max_min_locs</span><span class="p">]</span>     <span class="c1"># Values of above indices    </span>
    <span class="n">abs_max_min_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_min_values</span><span class="p">)</span>     <span class="c1"># Absolute value of those values</span>

    <span class="c1"># A vector with a length equal to the number of minimums: all &#39;-1&#39; to say minimum</span>
    <span class="n">numMin</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">min_locs</span><span class="p">)</span>    
    <span class="n">numMax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">max_locs</span><span class="p">)</span>     <span class="c1"># Same for max, but with &#39;1&#39;</span>
    <span class="n">isMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numMax</span><span class="p">,</span> <span class="n">numMin</span><span class="p">)</span>
    <span class="n">val_and_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">abs_max_min_values</span><span class="p">,</span> <span class="n">max_min_locs</span><span class="p">,</span> <span class="n">isMin</span><span class="p">])</span>
    <span class="c1"># Sort the magnitudes of the extrema in descending order (-1 indicates descending)</span>
    <span class="n">val_and_idx_sorted</span> <span class="o">=</span> <span class="n">val_and_idx</span><span class="p">[</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">val_and_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
    
    <span class="c1"># We will continue looping until we have an appropriate classification. </span>
    <span class="c1"># This relies on having the extrema INTERCHANGE between max and min (no two min right next to eachother)</span>
    <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">classificationFound</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">classificationFound</span> <span class="ow">and</span> <span class="n">loops</span> <span class="o">&lt;</span> <span class="n">max_loops</span><span class="p">:</span>
        
        <span class="n">top_2</span> <span class="o">=</span> <span class="n">val_and_idx_sorted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>             <span class="c1"># Take the top two magnitudes</span>
        <span class="n">top_2_sorted</span> <span class="o">=</span> <span class="n">top_2</span><span class="p">[</span> <span class="p">:,</span> <span class="n">top_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>   <span class="c1"># Sort according to the indices of those values</span>
        <span class="k">if</span> <span class="n">top_2_sorted</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>               <span class="c1"># Break if we run out of turning points</span>
            <span class="k">return</span> <span class="s2">&quot;_&quot;</span>
        
        <span class="c1"># If two min or two max occur one after the other, </span>
        <span class="c1"># we know we have an inappropriate result so we delete one of those doubled min/max</span>
        <span class="k">if</span> <span class="n">top_2_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">top_2_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">val_and_idx_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">val_and_idx_sorted</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">classificationFound</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">loops</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">top_2_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;L&#39;</span>
    <span class="k">elif</span> <span class="n">top_2_sorted</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;R&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;_&quot;</span>

<span class="c1"># finds the index of the max and min values in the wave, then classifies</span>
<span class="c1"># based on whether the max or min value occurred first</span>
<span class="k">def</span> <span class="nf">max_min_classifier</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">downsample_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">arr_ds</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">downsample_rate</span><span class="p">]</span>
    <span class="n">arr_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">)</span>
    <span class="n">arr_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">)</span>
    <span class="n">max_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr_ds</span> <span class="o">==</span> <span class="n">arr_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">min_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr_ds</span> <span class="o">==</span> <span class="n">arr_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">max_loc</span> <span class="o">&gt;</span> <span class="n">min_loc</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;R&quot;</span>
    <span class="k">elif</span> <span class="n">min_loc</span> <span class="o">&gt;</span> <span class="n">max_loc</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;L&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;_&quot;</span>

<span class="c1"># finds the index of the max and min values in the wave, then checks whether both</span>
<span class="c1"># values are outside the range. If both are outside, then classification is based</span>
<span class="c1"># on whether max or min value occurred first. Else, if only one is outside, then</span>
<span class="c1"># classification is based on whether the max or min&#39;s magnitude is larger</span>
<span class="k">def</span> <span class="nf">max_min_range_classifier</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">downsample_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="mi">35</span><span class="p">):</span>
    <span class="n">arr_ds</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">downsample_rate</span><span class="p">]</span>
    <span class="n">arr_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">)</span>
    <span class="n">arr_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">arr_ds</span><span class="p">)</span>
    <span class="n">max_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr_ds</span> <span class="o">==</span> <span class="n">arr_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">min_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr_ds</span> <span class="o">==</span> <span class="n">arr_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">arr_max</span> <span class="o">&gt;</span> <span class="n">rng</span> <span class="ow">and</span> <span class="n">arr_min</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rng</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_loc</span> <span class="o">&gt;</span> <span class="n">min_loc</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;R&quot;</span>
        <span class="k">elif</span> <span class="n">min_loc</span> <span class="o">&gt;</span> <span class="n">max_loc</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;L&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;_&quot;</span>
    <span class="k">elif</span> <span class="n">arr_max</span> <span class="o">&gt;</span> <span class="n">rng</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;R&quot;</span>
    <span class="k">elif</span> <span class="n">arr_min</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rng</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;L&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;_&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare classifiers for optimisation and plotting</span>
<span class="n">classifiers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;One-pronged&quot;</span><span class="p">:</span> <span class="n">one_pronged_smoothing_classifier</span><span class="p">,</span>
               <span class="s2">&quot;Two-pronged&quot;</span><span class="p">:</span> <span class="n">two_pronged_smoothing_classifier</span><span class="p">,</span>
               <span class="s2">&quot;Max-Min&quot;</span><span class="p">:</span> <span class="n">max_min_classifier</span><span class="p">,</span>
               <span class="s2">&quot;Max-Min-Range&quot;</span><span class="p">:</span> <span class="n">max_min_range_classifier</span><span class="p">,</span>
               <span class="s2">&quot;Zeros&quot;</span><span class="p">:</span> <span class="n">zeroes_classifier</span><span class="p">,</span>
               <span class="s2">&quot;KNN&quot;</span><span class="p">:</span> <span class="n">catch22_knn_classifier</span><span class="p">,</span>
               <span class="s2">&quot;Naive Random&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="s2">&quot;R&quot;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">0.5</span> <span class="k">else</span> <span class="s2">&quot;L&quot;</span><span class="p">}</span>

<span class="n">classifier_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;One-pronged&quot;</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s2">&quot;Two-pronged&quot;</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s2">&quot;Max-Min&quot;</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s2">&quot;Max-Min-Range&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rng&quot;</span><span class="p">:</span><span class="mi">35</span><span class="p">},</span>
               <span class="s2">&quot;Zeros&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;consec_seconds&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;ave_height&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">},</span>
               <span class="s2">&quot;KNN&quot;</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s2">&quot;Naive Random&quot;</span><span class="p">:</span> <span class="p">{}}</span>

<span class="n">classifier_colours</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;One-pronged&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Two-pronged&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:cyan&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Max-Min&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:olive&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Max-Min-Range&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:brown&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Zeros&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:purple&quot;</span><span class="p">,</span>
               <span class="s2">&quot;KNN&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:pink&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Naive Random&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:red&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="accuracy-metric">
<h4>Accuracy Metric<a class="headerlink" href="#accuracy-metric" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_lev_dist</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">sub_L_cost</span> <span class="o">=</span> <span class="mf">1.25</span><span class="p">,</span> <span class="n">sub_R_cost</span> <span class="o">=</span> <span class="mf">1.25</span><span class="p">,</span>
                <span class="n">sub_under_score_cost</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">delete_under_score_cost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">delete_L_cost</span> <span class="o">=</span> <span class="mf">1.25</span><span class="p">,</span> <span class="n">delete_R_cost</span> <span class="o">=</span> <span class="mf">1.25</span><span class="p">):</span>
    <span class="n">substitute_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  
    <span class="n">substitute_costs</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sub_L_cost</span>
    <span class="n">substitute_costs</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sub_R_cost</span>
    <span class="n">substitute_costs</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sub_under_score_cost</span>
    <span class="n">substitute_costs</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sub_under_score_cost</span>
    <span class="n">delete_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">delete_costs</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">delete_under_score_cost</span>
    <span class="n">delete_costs</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">delete_L_cost</span>
    <span class="n">delete_costs</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">delete_R_cost</span>
    <span class="k">return</span> <span class="n">lev</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">substitute_costs</span> <span class="o">=</span> <span class="n">substitute_costs</span><span class="p">,</span> <span class="n">delete_costs</span> <span class="o">=</span> <span class="n">delete_costs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="classifier-optimisation">
<h4>Classifier Optimisation<a class="headerlink" href="#classifier-optimisation" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_hide-input tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_filename_cls_opt</span> <span class="o">=</span> <span class="n">OUT_PATH</span> <span class="o">+</span> <span class="s2">&quot;classifier_optimisation.csv&quot;</span>

<span class="k">if</span> <span class="n">compute_all</span><span class="p">:</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">output_filename_cls_opt</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    <span class="c1"># Clear the file</span>

    <span class="n">search_space</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="n">opt_det_window</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">granularity</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="k">for</span> <span class="n">classifier_label</span><span class="p">,</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classifier_label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="p">(</span><span class="n">granularity</span><span class="o">//</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">granularity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">classification_window</span> <span class="o">=</span> <span class="n">opt_det_window</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">w</span>
            <span class="n">buffer_size</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">waves</span><span class="p">):</span>
                <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_timestamps</span> <span class="o">=</span> <span class="n">streaming_classifier</span><span class="p">(</span>
                    <span class="n">waves</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                    <span class="n">samprate</span><span class="p">,</span>
                    <span class="n">classifier</span><span class="p">,</span>
                    <span class="n">classifier_params</span><span class="o">=</span><span class="n">classifier_parameters</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">],</span>
                    <span class="n">input_buffer_size_sec</span> <span class="o">=</span> <span class="n">buffer_size</span><span class="p">,</span>
                    <span class="n">classification_window_size_sec</span> <span class="o">=</span> <span class="n">classification_window</span><span class="p">,</span>
                    <span class="n">detection_window_size_sec</span> <span class="o">=</span> <span class="n">opt_det_window</span><span class="p">,</span>
                    <span class="n">detection_window_offset_sec</span> <span class="o">=</span> <span class="n">w</span><span class="p">,</span>
                    <span class="n">calibration_window_size_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                    <span class="n">calibration_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                    <span class="n">event_test_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                    <span class="n">event_threshold_factor</span> <span class="o">=</span> <span class="n">opt_thresh</span><span class="p">,</span> 
                    <span class="n">flip_threshold</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># Threshold is a lower bound, so true</span>
                    <span class="n">consecutive_event_triggers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                    <span class="n">consecutive_nonevent_reset</span> <span class="o">=</span> <span class="mi">10</span> 
                <span class="p">)</span>
                <span class="n">actuals</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="n">lev_dist</span> <span class="o">=</span> <span class="n">my_lev_dist</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">actuals</span><span class="p">)</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">actuals</span><span class="p">)</span> <span class="o">-</span> <span class="n">lev_dist</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">actuals</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename_cls_opt</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">classifier_label</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">classification_window</span><span class="p">),</span> 
                                         <span class="n">key</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">actuals</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lev_dist</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">acc</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_filename_cls_opt</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="s2">&quot;window_size&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;predicted&quot;</span><span class="p">,</span> <span class="s2">&quot;actual&quot;</span><span class="p">,</span> <span class="s2">&quot;lev_dist&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">]</span>
<span class="n">results_agg</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;window_size&quot;</span><span class="p">,</span> <span class="s2">&quot;classifier&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">results_agg</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimal_cl_windows</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">results_agg</span><span class="o">.</span><span class="n">classifier</span> <span class="o">==</span> <span class="n">classifier</span>
    <span class="n">max_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">results_agg</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">results_agg</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">optimal_cl_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results_agg</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">.</span><span class="n">window_size</span><span class="p">)[</span><span class="n">max_arg</span><span class="p">]</span>
    <span class="n">optimal_cl_windows</span><span class="p">[</span><span class="n">classifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimal_cl_window</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results_agg</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">results_agg</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
             <span class="n">label</span><span class="o">=</span><span class="n">classifier</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">optimal_cl_window</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">max_val</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">classifier_colours</span><span class="p">[</span><span class="n">classifier</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">optimal_cl_window</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">classifier_colours</span><span class="p">[</span><span class="n">classifier</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weighted Levenshtein Accuracy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Classification Window Length (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Classifier Accuracy vs. Classification Window Length&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">opt_det_window</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Detection Window Lowerbound&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUT_PATH</span><span class="o">+</span><span class="s2">&quot;classifier.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="figure align-default" id="classifier">
<a class="reference internal image-reference" href="_images/classifier.png"><img alt="_images/classifier.png" src="_images/classifier.png" style="width: 525.0px; height: 525.0px;" /></a>
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">Training accuracy of each classifier as a function of classification window length. The classification window is lower bounded by the detection window, represented by the shaded region.
Ideally, we want to minimise window length while maximising accuracy. With this in mind, we see that the Max-Min-Range classifier has the highest accuracy at a window length equal to be the lowerbound of 0.35 seconds. This makes it the most optimal classifier by both accuracy and latency.</span><a class="headerlink" href="#classifier" title="Permalink to this image">¶</a></p>
</div>
<!-- reference by {numref}`classifier` --></div>
<div class="section" id="evaluation">
<h4>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_filename_tst_res</span> <span class="o">=</span> <span class="n">OUT_PATH</span> <span class="o">+</span> <span class="s2">&quot;test_results.csv&quot;</span>

<span class="k">if</span> <span class="n">compute_all</span><span class="p">:</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">output_filename_tst_res</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    <span class="c1"># Clear the file</span>

    <span class="k">for</span> <span class="n">classifier_label</span><span class="p">,</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classifier_label</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">optimal_cl_windows</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">]</span> <span class="o">-</span> <span class="n">opt_det_window</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">buffer_size</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_waves</span><span class="p">):</span>
            <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_timestamps</span> <span class="o">=</span> <span class="n">streaming_classifier</span><span class="p">(</span>
                <span class="n">test_waves</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="n">samprate</span><span class="p">,</span>
                <span class="n">classifier</span><span class="p">,</span>
                <span class="n">classifier_params</span><span class="o">=</span><span class="n">classifier_parameters</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">],</span>
                <span class="n">input_buffer_size_sec</span> <span class="o">=</span> <span class="n">buffer_size</span><span class="p">,</span>
                <span class="n">classification_window_size_sec</span> <span class="o">=</span> <span class="n">optimal_cl_windows</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">],</span>
                <span class="n">detection_window_size_sec</span> <span class="o">=</span> <span class="n">opt_det_window</span><span class="p">,</span>
                <span class="n">detection_window_offset_sec</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span>
                <span class="n">calibration_window_size_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                <span class="n">calibration_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                <span class="n">event_test_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                <span class="n">event_threshold_factor</span> <span class="o">=</span> <span class="n">opt_thresh</span><span class="p">,</span> 
                <span class="n">flip_threshold</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">consecutive_event_triggers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                <span class="n">consecutive_nonevent_reset</span> <span class="o">=</span> <span class="mi">10</span> 
            <span class="p">)</span>
            <span class="n">actuals</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="n">lev_dist</span> <span class="o">=</span> <span class="n">my_lev_dist</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">actuals</span><span class="p">)</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">actuals</span><span class="p">)</span> <span class="o">-</span> <span class="n">lev_dist</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">actuals</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename_tst_res</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">classifier_label</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">actuals</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lev_dist</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">acc</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">test_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_filename_tst_res</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">test_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Classifier&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">,</span> <span class="s2">&quot;Predicted&quot;</span><span class="p">,</span> <span class="s2">&quot;Actual&quot;</span><span class="p">,</span> <span class="s2">&quot;Weighted Levenshtein Distance&quot;</span><span class="p">,</span> <span class="s2">&quot;Accuracy&quot;</span><span class="p">]</span>

<span class="n">test_results</span> <span class="o">=</span> <span class="n">test_results</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;File&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Classifier&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">test_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">test_results</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Classifier</th>
      <th>KNN</th>
      <th>Max-Min</th>
      <th>Max-Min-Range</th>
      <th>Naive Random</th>
      <th>One-pronged</th>
      <th>Two-pronged</th>
      <th>Zeros</th>
    </tr>
    <tr>
      <th>File</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>data5</th>
      <td>0.787037</td>
      <td>0.925926</td>
      <td>0.925926</td>
      <td>0.574074</td>
      <td>0.925926</td>
      <td>0.666667</td>
      <td>0.888889</td>
    </tr>
    <tr>
      <th>data7</th>
      <td>0.750000</td>
      <td>0.870968</td>
      <td>0.870968</td>
      <td>0.677419</td>
      <td>0.870968</td>
      <td>0.596774</td>
      <td>0.838710</td>
    </tr>
    <tr>
      <th>Total</th>
      <td>0.768519</td>
      <td>0.898447</td>
      <td>0.898447</td>
      <td>0.625747</td>
      <td>0.898447</td>
      <td>0.631720</td>
      <td>0.863799</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="summary-of-results">
<h2>Summary of results<a class="headerlink" href="#summary-of-results" title="Permalink to this headline">¶</a></h2>
<div class="section" id="physics-analysis-findings-to-do">
<h3>Physics Analysis Findings: TO DO<a class="headerlink" href="#physics-analysis-findings-to-do" title="Permalink to this headline">¶</a></h3>
<p>Adapting the final experimental design after testing as the larger loop in the workflow suggests:</p>
<ul class="simple">
<li><p>Calibration instead of normalisation (explain why we did this in a senetence e.g. normalisation only scaled the egneerated signal to specific bounds, but the scale of the signal played no roll in event detection)</p></li>
<li><p>Post it notes (placed beyond 45 degrees from central viewing line)</p></li>
<li><p>Speed of eye movements (fast but no quantitative value)</p></li>
<li><p>Electrode placement (3 cm apart at least)</p></li>
<li><p>Filter</p></li>
</ul>
<p>Other factors that we are aware will affect the ouput:</p>
<ul class="simple">
<li><p>blinking (didnt do anything as was not often they were detectable)</p></li>
<li><p>facial movements (ensured we used a detection metric that would not classify increased noise and amplitude as an event such as zero-crossings, which just so happened to be best performing metric anyway).</p></li>
</ul>
<p>…thus we ask users to play still, emphasising left and right movements.</p>
</div>
<div class="section" id="data-analysis-finding-to-do">
<h3>Data analysis finding TO DO<a class="headerlink" href="#data-analysis-finding-to-do" title="Permalink to this headline">¶</a></h3>
<p>Results for data</p>
</div>
</div>
<div class="section" id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="space-invaders">
<h2>Space Invaders!<a class="headerlink" href="#space-invaders" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">encode_msg_size</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decode_msg_size</span><span class="p">(</span><span class="n">size_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">size_bytes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">create_msg</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encode_msg_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">content</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_labelled_wave</span><span class="p">(</span><span class="n">wav_array</span><span class="p">,</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">labels_dat</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">calibration_seconds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
                       <span class="n">before_buffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">after_buffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wave_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                       <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">512</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">512</span><span class="p">):</span>
    <span class="n">time_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">))</span><span class="o">/</span><span class="n">samprate</span>
    
    <span class="c1"># Calibration period</span>
    <span class="n">calibration_bool</span> <span class="o">=</span> <span class="n">time_seq</span> <span class="o">&lt;</span> <span class="n">calibration_seconds</span>

    <span class="c1"># Get locations of events</span>
    <span class="n">left_events_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">time_seq</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">labels_dat</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">labels_dat</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">]:</span>
        <span class="n">left_events_bool</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">time_seq</span> <span class="o">&gt;</span> <span class="n">time</span> <span class="o">-</span> <span class="n">before_buffer</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time_seq</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">+</span><span class="n">after_buffer</span><span class="p">)</span> <span class="p">)</span> <span class="o">|</span> <span class="n">left_events_bool</span>
    <span class="n">right_events_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">time_seq</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">labels_dat</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">labels_dat</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">]:</span>
        <span class="n">right_events_bool</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">time_seq</span> <span class="o">&gt;</span> <span class="n">time</span> <span class="o">-</span> <span class="n">before_buffer</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time_seq</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">+</span><span class="n">after_buffer</span><span class="p">)</span> <span class="p">)</span> <span class="o">|</span> <span class="n">right_events_bool</span>

    <span class="c1"># Plot wave with events</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_seq</span><span class="p">,</span> <span class="n">wav_array</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">wave_alpha</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_seq</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span>
                     <span class="n">where</span> <span class="o">=</span> <span class="n">left_events_bool</span><span class="p">,</span>
                     <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span>
                     <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Left&quot;</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="n">shade_alpha</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_seq</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span>
                     <span class="n">where</span> <span class="o">=</span> <span class="n">right_events_bool</span><span class="p">,</span>
                     <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span>
                     <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Right&quot;</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="n">shade_alpha</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_seq</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span>
                     <span class="n">where</span> <span class="o">=</span> <span class="n">calibration_bool</span><span class="p">,</span>
                     <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
                     <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Calibration&quot;</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="n">shade_alpha</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">waves</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
    <span class="n">plot_labelled_wave</span><span class="p">(</span>
        <span class="n">waves</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ax</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">before_buffer</span> <span class="o">=</span> <span class="n">time_buffers_whole</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">after_buffer</span> <span class="o">=</span> <span class="n">time_buffers_whole</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wave_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">test_waves</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
    <span class="n">plot_labelled_wave</span><span class="p">(</span>
        <span class="n">test_waves</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">samprate</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ax</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">before_buffer</span> <span class="o">=</span> <span class="n">time_buffers_whole</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">after_buffer</span> <span class="o">=</span> <span class="n">time_buffers_whole</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wave_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUT_PATH</span> <span class="o">+</span> <span class="s2">&quot;dataset_plot.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Final classifier used for Space Invaders</span>

<span class="c1"># Connect to spiker box - change to match port</span>
<span class="n">cport</span> <span class="o">=</span> <span class="s2">&quot;/dev/cu.usbserial-DJ00E33Q&quot;</span>
<span class="n">baudrate</span> <span class="o">=</span> <span class="mi">230400</span>
<span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">cport</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">)</span>    
<span class="n">inputBufferSize</span> <span class="o">=</span> <span class="mi">1000</span>   <span class="c1"># 20000 = 1 second</span>
<span class="n">buffer_size_sec</span> <span class="o">=</span> <span class="n">inputBufferSize</span><span class="o">/</span><span class="mf">20000.0</span>
<span class="n">ser</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">buffer_size_sec</span>  <span class="c1"># set read timeout 20000</span>

<span class="n">classifier_label</span> <span class="o">=</span> <span class="s2">&quot;Max-Min-Range&quot;</span>
<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">optimal_cl_windows</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">]</span> <span class="o">-</span> <span class="n">opt_det_window</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">buffer_size</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">streaming_classifier</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">,</span>
    <span class="n">samprate</span><span class="p">,</span>
    <span class="n">classifiers</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">],</span>
    <span class="n">classifier_params</span><span class="o">=</span><span class="n">classifier_parameters</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">],</span>
    <span class="n">input_buffer_size_sec</span> <span class="o">=</span> <span class="n">buffer_size_sec</span><span class="p">,</span>
    <span class="n">classification_window_size_sec</span> <span class="o">=</span> <span class="n">optimal_cl_windows</span><span class="p">[</span><span class="n">classifier_label</span><span class="p">],</span>
    <span class="n">detection_window_size_sec</span> <span class="o">=</span> <span class="n">opt_det_window</span><span class="p">,</span>
    <span class="n">detection_window_offset_sec</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span>
    <span class="n">calibration_window_size_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">calibration_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
    <span class="n">event_test_statistic_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ts_zero_crossings</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
    <span class="n">event_threshold_factor</span> <span class="o">=</span> <span class="n">opt_thresh</span><span class="p">,</span> 
    <span class="n">flip_threshold</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
    <span class="n">consecutive_event_triggers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
    <span class="n">consecutive_nonevent_reset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">live</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">FIFO_filename</span> <span class="o">=</span> <span class="s2">&quot;space_invaders_ipc&quot;</span><span class="p">,</span>
    <span class="n">create_FIFO_msg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using backward stepwise feature selection from catch22 for kNN classifier </span>

<span class="c1"># import decision tree classifier to model fitting and recursive feature exclusion (stepwise selection)</span>

<span class="n">KNN_DATA_PATH</span> <span class="o">=</span> <span class="n">IN_PATH</span> <span class="o">+</span> <span class="s2">&quot;KNN/&quot;</span>

<span class="n">knn_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left-middle-right-middle#2&#39;</span><span class="p">,</span> <span class="s1">&#39;left-middle-right-middle&#39;</span><span class="p">,</span> <span class="s1">&#39;left-middle-right-steph&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;left-middle-right-steph2&#39;</span><span class="p">,</span> <span class="s1">&#39;left-middle&#39;</span><span class="p">,</span> <span class="s1">&#39;left-right-middle-marina&#39;</span><span class="p">,</span> <span class="s1">&#39;left-right-middle-marina2&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;left-right-middle-marina3&#39;</span><span class="p">,</span> <span class="s1">&#39;left-right-middle-sandeep&#39;</span><span class="p">,</span> <span class="s1">&#39;right-middle&#39;</span><span class="p">]</span>

<span class="c1"># Load the data</span>
<span class="n">knn_waves</span><span class="p">,</span> <span class="n">knn_labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span>
    <span class="n">KNN_DATA_PATH</span><span class="p">,</span> <span class="n">knn_names</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shift_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">512</span><span class="p">)</span>

<span class="c1"># Define sample rate: 10,000 Hz</span>
<span class="n">samprate</span> <span class="o">=</span> <span class="mi">10_000</span>

<span class="c1"># Extract events from training data</span>
<span class="n">before_buffer</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">after_buffer</span> <span class="o">=</span> <span class="mi">1</span>
    
<span class="n">events</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of events in terms of slice of wav_array</span>
<span class="n">event_labels</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of labels</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">knn_labels</span><span class="p">:</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">knn_waves</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">knn_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lab</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">label</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
        <span class="n">event_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
        <span class="n">event_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">before_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">samprate</span><span class="p">)</span> <span class="c1"># in terms of sampling rate</span>
        <span class="n">event_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span> <span class="o">+</span> <span class="n">after_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">samprate</span><span class="p">)</span> <span class="c1"># in terms of sampling rate</span>

        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wave</span><span class="p">[</span><span class="n">event_start</span><span class="p">:</span><span class="n">event_end</span><span class="p">])</span>
        
<span class="c1"># Compute catch22 features and convert to dataframe</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
    <span class="n">event_ds</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">10</span><span class="p">]</span> <span class="c1"># downsample by a rate of 10</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="n">catch22_all</span><span class="p">(</span><span class="n">event_ds</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>

<span class="n">features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">features_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span>

<span class="c1"># fit the model</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">420</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_df</span><span class="p">,</span> <span class="n">event_labels</span><span class="p">)</span>

<span class="c1"># Python backward stepwise selection</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">RFECV</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">features_trans</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">features_df</span><span class="p">,</span> <span class="n">event_labels</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">features_trans</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">columns_retained</span> <span class="o">=</span> <span class="n">features_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">trans</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">columns_retained</span><span class="p">)</span>

<span class="c1"># create df to save as csv for kNN classifier</span>
<span class="n">selected_features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_trans</span><span class="p">)</span>
<span class="n">selected_features_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns_retained</span>
<span class="n">selected_features_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_labels</span>

<span class="c1"># selected_features_df.to_csv(DEP_PATH+&#39;catch22_step_selected_features.csv&#39;,index=False)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p><span id="id4">[<a class="reference internal" href="#id8">VR21</a>]</span>
<span id="id5">[<a class="reference internal" href="#id9">con21</a>]</span>
<span id="id6">[<a class="reference internal" href="#id10">BYB</a>]</span></p>
<p id="id7"><dl class="citation">
<dt class="label" id="id10"><span class="brackets">BYB</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id6">2</a>)</span></dt>
<dd><p>The heart and brain spikerbox. URL: <a class="reference external" href="https://backyardbrains.com/products/heartAndBrainSpikerBox">https://backyardbrains.com/products/heartAndBrainSpikerBox</a>.</p>
</dd>
<dt class="label" id="id8"><span class="brackets">VR21</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id4">2</a>)</span></dt>
<dd><p>Mar 2021. URL: <a class="reference external" href="https://www.grandviewresearch.com/industry-analysis/virtual-reality-vr-market">https://www.grandviewresearch.com/industry-analysis/virtual-reality-vr-market</a>.</p>
</dd>
<dt class="label" id="id9"><span class="brackets">con21</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id5">2</a>)</span></dt>
<dd><p>Wikipedia contributors. Space invaders. 2021. Online; accessed 10-June-2021. URL: <a class="reference external" href="https://en.wikipedia.org/w/index.php?title=Space_Invaders&amp;oldid=1027084097">https://en.wikipedia.org/w/index.php?title=Space_Invaders&amp;oldid=1027084097</a>.</p>
</dd>
</dl>
</p>
<p><a class="reference external" href="http://blog.juliusschulz.de/blog/ultimate-ipython-notebook">http://blog.juliusschulz.de/blog/ultimate-ipython-notebook</a></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Brain10<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>